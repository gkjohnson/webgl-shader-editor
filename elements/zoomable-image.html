<dom-module id="zoomable-image">
    <template>
        <style>
            :host {
                display: block;
                position: relative;
            }
            
            #proxy-image {
                visibility: hidden;
            }

            #zoom-container {
                width: 100%;
                height: 100%;
                position: absolute;
                overflow: hidden;
                top: 0;
                left: 0;
            }

            #zoom-image {
                position: absolute;
            }


        </style>

        <!--
            Image used to scale the container
            appropriately
        -->
        <img
            id="proxy-image"
            src="[[src]]"
        />

        <div id="zoom-container">        
            <img
                id="zoom-image"
                src="[[src]]"
                style="[[_getStyle(scale, xOffset, yOffset)]]"
            />
        </div>
    </template>
</dom-module>

<script type="text/javascript">
    class ZoomableImage extends Polymer.Element {
        static get is() { return 'zoomable-image' }

        static get properties() {
            return {
                scale: {
                    type: Number,
                    value: 1,
                    notify: true,
                    observer: '_scaleObserver'
                },

                maxScale: {
                    type: Number,
                    value: 10
                },

                src: {
                    type: String,
                    value: ''
                },

                xOffset: {
                    type: Number,
                    value: 0,
                    notify: true
                },

                yOffset: {
                    type: Number,
                    value: 0,
                    notify: true
                },

                _dragging: {
                    type: Boolean,
                    value: false
                }
            }
        }

        static get observers() {
            return ['_offsetObserver(xOffset, yOffset, scale, src)']
        }

        // Lifecycle
        ready() {
            super.ready()

            this.addEventListener('wheel', e => {
                const oldScale = this.scale

                // set the scale first because the
                // offsets are clamped by the scale
                // and the scale is clamped by
                // the max value
                this.scale = oldScale - e.deltaY * 1e-2
                const newScale = this.scale

                // calculate the offset before and after
                // the scale change and move the offset by
                // that amount to keep the mouse over the
                // current pixel
                const xpxdelta = Math.floor(e.offsetX / newScale) - Math.floor(e.offsetX / oldScale)
                const ypxdelta = Math.floor(e.offsetY / newScale) - Math.floor(e.offsetY / oldScale)

                this.xOffset += xpxdelta
                this.yOffset += ypxdelta
            })

            let lastPageX, lastPageY
            this.addEventListener('mousedown', e => {
                if (e.which !== 2) return
                    console.log("ASDF")
                this._dragging = true
                
                lastPageX = e.pageX
                lastPageY = e.pageY
            })

            document.addEventListener('mouseup', e => {
                if (e.which !== 2) return

                this._dragging = false
            })

            document.addEventListener('mousemove', e => {
                if (!this._dragging) return

                const deltaX = e.pageX - lastPageX
                const deltaY = e.pageY - lastPageY

                this.xOffset += deltaX / this.scale
                this.yOffset += deltaY / this.scale

                lastPageX = e.pageX
                lastPageY = e.pageY
            })
        }

        // Utilities
        _getStyle(s, x, y) {
            x = Math.floor(x)            
            y = Math.floor(y)            
            x *= s
            y *= s
            s *= 100

            return `width:${s}%; top:${y}px; left:${x}px;`
        }

        // Observers
        _scaleObserver(s) {
            s = Math.max(1, Math.min(this.maxScale, s))
            if (this.scale !== s) this.scale = s
        }

        _offsetObserver(x, y, s, src) {
            const prox = this.shadowRoot.querySelector('#proxy-image')

            const maxX = prox.width - prox.width / s
            const maxY = prox.height - prox.height / s

            // don't go past the top left edge
            x = Math.max(-maxX, Math.min(0, x))
            y = Math.max(-maxY, Math.min(0, y))

            if (this.xOffset !== x) this.xOffset = x
            if (this.yOffset !== y) this.yOffset = y
        }
    }

    customElements.define(ZoomableImage.is, ZoomableImage)
</script>